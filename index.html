<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<title>Roscoe Medication Schedule Generator</title>
<style>
  :root {
    --page-w: 5in;
    --gap: 12px;
    --radius: 14px;
    --ink: #111;
    --muted: #6b7280;
    --line: #e5e7eb;
    --scale: 0.8;
    --touch-target: 44px; /* iOS recommended minimum */
  }
  
  /* Print layout: 5in wide, variable height */
  @page { size: 5in auto; margin: 0.5in; }
  
  @media print {
    body {
      -webkit-print-color-adjust: exact; 
      print-color-adjust: exact; 
      margin: 0;
    }
    .no-print { display: none !important; }
    .sheet { 
      box-shadow: none; 
      transform: scale(1) !important;
      width: 100%;
      max-width: 100%;
    }
    dialog[open] { display: none !important; }
    header .sub { display: none !important; }
  }

  * {
    -webkit-tap-highlight-color: rgba(0,0,0,0.05);
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial, system-ui, sans-serif;
    color: var(--ink);
    background: #f6f7f9;
    margin: 0;
    padding: 16px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .container { 
    display: grid; 
    place-content: start center; 
    gap: var(--gap); 
    padding-bottom: 24px; 
  }
  
  .sheet {
    width: min(100%, var(--page-w));
    background: #fff;
    border-radius: var(--radius);
    box-shadow: 0 12px 30px rgba(0,0,0,0.08);
    border: 1px solid var(--line);
    overflow: hidden;
    transform: scale(var(--scale));
    transform-origin: top center;
    margin: 0 auto;
  }
  
  .sheet > img {
    display: block;
    margin: 12px auto 0;
    max-width: 0.6in;
    height: auto;
    object-fit: contain;
  }
  
  header {
    padding: 16px 16px 12px;
    border-bottom: 1px solid var(--line);
  }
  
  header h1 { 
    font-size: 20px; 
    margin: 0 0 6px; 
    font-weight: 700;
  }
  
  header .sub { 
    font-size: 13px; 
    color: var(--muted);
    line-height: 1.5;
  }

  table { 
    width: 100%; 
    border-collapse: collapse; 
  }
  
  thead th {
    text-align: left; 
    font-size: 12px; 
    font-weight: 600;
    padding: 10px 12px; 
    border-bottom: 1px solid var(--line); 
    background: #fafafa;
  }
  
  tbody td {
    font-size: 12px; 
    padding: 12px; 
    border-bottom: 1px solid #f0f2f5; 
    vertical-align: top;
  }
  
  .dateCell { 
    width: 34%; 
    white-space: nowrap; 
    font-weight: 600;
  }
  
  .slotRow { 
    display: grid; 
    grid-template-columns: auto 1fr auto; 
    gap: 10px; 
    align-items: start; 
  }
  
  .slotLabel { 
    font-weight: 600; 
    min-width: 32px;
  }
  
  .medText { 
    color: #111; 
    line-height: 1.4;
  }
  
  .empty { 
    color: var(--muted); 
    font-style: italic; 
  }
  
  /* Touch-friendly checkbox */
  .checkBox { 
    width: 28px; 
    height: 28px; 
    min-width: 28px;
    border-radius: 6px; 
    border: 2px solid #9aa3ad; 
    display: inline-grid; 
    place-items: center; 
    cursor: pointer;
    transition: all 0.2s ease;
    -webkit-user-select: none;
    user-select: none;
  }
  
  .checkBox:active {
    transform: scale(0.95);
    background: #f3f4f6;
  }
  
  .checkBox input { 
    width: 22px; 
    height: 22px; 
    margin: 0; 
    cursor: pointer;
  }
  
  footer { 
    padding: 12px 16px 16px; 
    font-size: 11px; 
    color: var(--muted);
    line-height: 1.6;
  }
  
  .note { 
    margin-top: 8px; 
    font-size: 11px; 
    color: #374151;
    line-height: 1.5;
  }

  /* Mobile-optimized toolbar */
  .toolbar.no-print {
    display: flex; 
    gap: 10px; 
    flex-wrap: wrap; 
    align-items: center; 
    justify-content: center;
    padding: 0 8px;
  }
  
  .btn {
    all: unset; 
    cursor: pointer; 
    user-select: none;
    font: inherit; 
    padding: 12px 16px; 
    border-radius: 12px;
    background: #111827; 
    color: #fff; 
    border: 1px solid #0f172a;
    font-weight: 600;
    min-height: var(--touch-target);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .btn:active {
    transform: scale(0.98);
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  
  .btn.secondary { 
    background: #fff; 
    color: #111827; 
    border: 1px solid #c7ccd1; 
  }

  /* Mobile-friendly scale control */
  .scale-control {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #fff;
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid var(--line);
  }
  
  .scale-control label {
    font-size: 12px;
    color: #374151;
    white-space: nowrap;
  }
  
  .scale-control input[type="range"] {
    min-width: 100px;
  }
  
  .scale-control span {
    min-width: 40px;
    text-align: right;
    font-size: 13px;
    color: #111;
    font-weight: 600;
  }

  /* Enhanced modal for mobile */
  dialog {
    border: none; 
    border-radius: 16px; 
    padding: 0; 
    width: min(calc(100vw - 32px), 540px);
    max-height: calc(100vh - 40px);
    box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
    overflow: hidden; 
    background: #fff;
  }
  
  dialog::backdrop {
    background: rgba(0, 0, 0, 0.5);
    -webkit-backdrop-filter: blur(4px);
    backdrop-filter: blur(4px);
  }
  
  .dlg-head { 
    padding: 16px 20px; 
    border-bottom: 1px solid var(--line);
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 10;
  }
  
  .dlg-head h2 { 
    margin: 0; 
    font-size: 20px; 
    font-weight: 700;
  }
  
  .dlg-body { 
    padding: 16px 20px; 
    display: grid; 
    gap: 16px;
    overflow-y: auto;
    max-height: calc(100vh - 200px);
  }
  
  .grid-2 { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 14px; 
  }
  
  /* Stack on very small screens */
  @media (max-width: 480px) {
    .grid-2 { 
      grid-template-columns: 1fr; 
    }
  }
  
  label { 
    display: grid; 
    gap: 8px; 
    font-size: 14px; 
    color: #111; 
    font-weight: 500;
  }
  
  input[type="date"], 
  input[type="text"], 
  select, 
  textarea, 
  input[type="file"], 
  input[type="number"] {
    font: inherit; 
    padding: 12px 14px; 
    border-radius: 10px; 
    border: 1px solid #c7ccd1; 
    background: #fff;
    font-size: 16px; /* Prevents iOS zoom on focus */
    min-height: var(--touch-target);
    transition: border-color 0.2s ease;
  }
  
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #111827;
    box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.1);
  }
  
  textarea { 
    min-height: 90px; 
    resize: vertical;
    font-family: inherit;
  }
  
  .inline { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    font-size: 14px; 
  }
  
  .inline input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
  }
  
  .dlg-foot { 
    padding: 14px 20px 16px; 
    display: flex; 
    gap: 10px; 
    justify-content: space-between; 
    border-top: 1px solid var(--line);
    position: sticky;
    bottom: 0;
    background: #fff;
    z-index: 10;
  }
  
  .dlg-foot .btn {
    flex: 1;
    min-width: 0;
  }
  
  .hint { 
    font-size: 12px; 
    color: var(--muted);
    line-height: 1.4;
    margin-top: -4px;
  }
  
  /* Loading state */
  .btn.loading {
    opacity: 0.7;
    pointer-events: none;
  }
  
  /* Success message */
  .toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #111827;
    color: #fff;
    padding: 12px 24px;
    border-radius: 10px;
    font-size: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    z-index: 1000;
    animation: slideUp 0.3s ease;
  }
  
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="toolbar no-print">
      <button class="btn" id="openPrompts">üìã Generate New Schedule</button>
      <button class="btn secondary" id="printBtn">üñ®Ô∏è Print / Save PDF</button>
      <div class="scale-control">
        <label for="scale">Scale</label>
        <input id="scale" type="range" min="60" max="120" step="5" value="80" />
        <span id="scaleVal">80%</span>
      </div>
    </div>

    <div class="sheet" id="sheet">
      <img id="headerImg" alt="Roscoe's photo" style="display:none" />
      <header>
        <h1>üêï Roscoe ‚Äì Medication Checklist</h1>
        <div class="sub no-print">
          Tap "Generate New Schedule" to set dates and details, then use "Print / Save PDF" to create a 5" wide printable checklist.
        </div>
      </header>

      <table>
        <thead>
          <tr>
            <th class="dateCell">Date</th>
            <th>AM (Breakfast)</th>
            <th>PM (Dinner)</th>
          </tr>
        </thead>
        <tbody id="rows">
          <!-- Rows will be generated here -->
        </tbody>
      </table>

      <footer>
        <strong>Medication Details:</strong><br>
        AM ‚Äì Azathioprine ¬Ω tab (per schedule). PM ‚Äì Cosequin ¬Ω tab daily with dinner.
        <div id="metaLine" class="note"></div>
        <div id="notesLine" class="note"></div>
      </footer>
    </div>
  </div>

  <!-- Configuration dialog -->
  <dialog id="promptDlg">
    <form method="dialog" id="configForm">
      <div class="dlg-head">
        <h2>Build Medication Schedule</h2>
      </div>
      <div class="dlg-body">
        <div class="grid-2">
          <label>
            Start date *
            <input id="start" type="date" required aria-required="true" />
          </label>
          <label>
            End date *
            <input id="end" type="date" required aria-required="true" />
          </label>
        </div>

        <div class="grid-2">
          <label>
            Care location (optional)
            <input id="location" type="text" placeholder="e.g., Boarding facility" />
          </label>
          <label>
            Caregiver name (optional)
            <input id="caregiver" type="text" placeholder="e.g., Friend's name" />
          </label>
        </div>

        <label>
          Additional notes for caregiver (optional)
          <textarea id="notes" placeholder="E.g., feeding times, emergency contact info, special instructions..."></textarea>
        </label>

        <div class="grid-2">
          <label class="inline" title="If checked, Azathioprine is given on the start date, then every other day. If unchecked, first dose is the day after start date.">
            <input id="azaOnStart" type="checkbox" checked />
            <span>Give Azathioprine on start date</span>
          </label>
          <label>
            Azathioprine frequency
            <select id="azaEvery">
              <option value="2" selected>Every other day</option>
              <option value="3">Every 3 days</option>
              <option value="4">Every 4 days</option>
            </select>
          </label>
        </div>

        <label>
          Header image (optional)
          <input id="imageFile" type="file" accept="image/*" />
          <div class="hint">Add a photo of Roscoe to appear at the top of the schedule.</div>
        </label>

        <label>
          Print scale (60%‚Äì120%)
          <input id="scalePrompt" type="number" min="60" max="120" step="5" value="80" />
          <div class="hint">Default 80%. Increase if your schedule is too long to fit on one page.</div>
        </label>
      </div>
      <div class="dlg-foot">
        <button class="btn secondary" type="button" id="cancelBtn">Cancel</button>
        <button class="btn" type="submit" id="buildBtn">Build & Print</button>
      </div>
    </form>
  </dialog>

<script>
(function(){
  'use strict';
  
  // DOM elements
  const startEl = document.getElementById('start');
  const endEl = document.getElementById('end');
  const locEl = document.getElementById('location');
  const cgEl = document.getElementById('caregiver');
  const notesEl = document.getElementById('notes');
  const azaOnStartEl = document.getElementById('azaOnStart');
  const azaEveryEl = document.getElementById('azaEvery');
  const imgInput = document.getElementById('imageFile');
  const scaleRange = document.getElementById('scale');
  const scaleVal = document.getElementById('scaleVal');
  const scalePrompt = document.getElementById('scalePrompt');
  const rowsEl = document.getElementById('rows');
  const headerImg = document.getElementById('headerImg');
  const metaLine = document.getElementById('metaLine');
  const notesLine = document.getElementById('notesLine');
  const dlg = document.getElementById('promptDlg');
  const configForm = document.getElementById('configForm');
  const openPrompts = document.getElementById('openPrompts');
  const buildBtn = document.getElementById('buildBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const printBtn = document.getElementById('printBtn');

  // Utility functions
  function parseDateInput(value) {
    if (!value) return new Date(NaN);
    const parts = value.split('-').map(Number);
    if (parts.length !== 3) return new Date(NaN);
    const [y, m, d] = parts;
    return new Date(y, m - 1, d);
  }

  function toLocalInputValue(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

  function addDays(d, n) {
    return new Date(d.getFullYear(), d.getMonth(), d.getDate() + n);
  }

  function formatDateNice(d) {
    const opts = { weekday: 'short', month: 'short', day: 'numeric' };
    return d.toLocaleDateString(undefined, opts);
  }

  function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // Initialize date inputs
  const today = new Date();
  startEl.value = toLocalInputValue(today);
  endEl.value = toLocalInputValue(addDays(today, 6));

  // Scale management
  function applyScale(pct) {
    const clamped = Math.max(60, Math.min(120, Number(pct) || 80));
    document.documentElement.style.setProperty('--scale', (clamped/100).toString());
    if (scaleRange) scaleRange.value = clamped;
    if (scaleVal) scaleVal.textContent = clamped + '%';
    if (scalePrompt) scalePrompt.value = clamped;
  }

  applyScale(80);

  if (scaleRange) {
    scaleRange.addEventListener('input', () => applyScale(scaleRange.value));
  }
  if (scalePrompt) {
    scalePrompt.addEventListener('input', () => applyScale(scalePrompt.value));
  }

  // Build schedule
  function build() {
    if (scalePrompt) applyScale(scalePrompt.value || 80);

    rowsEl.innerHTML = '';

    const start = parseDateInput(startEl.value);
    const end = parseDateInput(endEl.value);
    
    if (!(start instanceof Date) || !(end instanceof Date) || isNaN(start) || isNaN(end) || end < start) {
      alert('Please choose a valid start and end date (end must be on or after start).');
      return false;
    }

    const azaEvery = parseInt(azaEveryEl.value, 10);
    const azaOnStart = azaOnStartEl.checked;

    let dayIndex = 0;
    for (let d = new Date(start); d <= end; d = addDays(d, 1), dayIndex++) {
      const tr = document.createElement('tr');

      // Date cell
      const dateTd = document.createElement('td');
      dateTd.className = 'dateCell';
      dateTd.textContent = formatDateNice(d);
      tr.appendChild(dateTd);

      // AM cell
      const amTd = document.createElement('td');
      const amRow = document.createElement('div');
      amRow.className = 'slotRow';
      
      const amLabel = document.createElement('span');
      amLabel.className = 'slotLabel';
      amLabel.textContent = 'AM';
      amRow.appendChild(amLabel);
      
      const giveAza = ((dayIndex % azaEvery) === 0) === azaOnStart;
      const amText = document.createElement('span');
      amText.className = 'medText ' + (giveAza ? '' : 'empty');
      amText.textContent = giveAza ? 'Azathioprine ¬Ω tab' : '‚Äî';
      amRow.appendChild(amText);
      
      const amCheck = document.createElement('label');
      amCheck.className = 'checkBox';
      const amInput = document.createElement('input');
      amInput.type = 'checkbox';
      amInput.setAttribute('aria-label', `AM medication for ${formatDateNice(d)}`);
      amCheck.appendChild(amInput);
      amRow.appendChild(amCheck);
      
      amTd.appendChild(amRow);
      tr.appendChild(amTd);

      // PM cell
      const pmTd = document.createElement('td');
      const pmRow = document.createElement('div');
      pmRow.className = 'slotRow';
      
      const pmLabel = document.createElement('span');
      pmLabel.className = 'slotLabel';
      pmLabel.textContent = 'PM';
      pmRow.appendChild(pmLabel);
      
      const pmText = document.createElement('span');
      pmText.className = 'medText';
      pmText.textContent = 'Cosequin ¬Ω tab';
      pmRow.appendChild(pmText);
      
      const pmCheck = document.createElement('label');
      pmCheck.className = 'checkBox';
      const pmInput = document.createElement('input');
      pmInput.type = 'checkbox';
      pmInput.setAttribute('aria-label', `PM medication for ${formatDateNice(d)}`);
      pmCheck.appendChild(pmInput);
      pmRow.appendChild(pmCheck);
      
      pmTd.appendChild(pmRow);
      tr.appendChild(pmTd);

      rowsEl.appendChild(tr);
    }

    // Update metadata
    const parts = [];
    if (locEl.value) parts.push('Location: ' + locEl.value);
    if (cgEl.value) parts.push('Caregiver: ' + cgEl.value);
    metaLine.textContent = parts.join(' ‚Ä¢ ');
    notesLine.textContent = notesEl.value.trim() ? ('Notes: ' + notesEl.value.trim()) : '';

    // Handle optional image
    if (imgInput.files && imgInput.files[0]) {
      const reader = new FileReader();
      reader.onload = () => {
        headerImg.src = reader.result;
        headerImg.style.display = 'block';
        setTimeout(() => {
          window.print();
          showToast('Schedule ready to print!');
        }, 150);
      };
      reader.readAsDataURL(imgInput.files[0]);
    } else {
      headerImg.removeAttribute('src');
      headerImg.style.display = 'none';
      setTimeout(() => {
        window.print();
        showToast('Schedule ready to print!');
      }, 50);
    }

    return true;
  }

  // Event listeners
  openPrompts.addEventListener('click', () => {
    try { 
      dlg.showModal(); 
    } catch(e) { 
      dlg.setAttribute('open',''); 
    }
  });

  cancelBtn.addEventListener('click', () => {
    try { 
      dlg.close(); 
    } catch(e) { 
      dlg.removeAttribute('open'); 
    }
  });

  configForm.addEventListener('submit', (e) => {
    e.preventDefault();
    if (build()) {
      try { 
        dlg.close(); 
      } catch(e) { 
        dlg.removeAttribute('open'); 
      }
    }
  });

  printBtn.addEventListener('click', () => {
    if (rowsEl.children.length === 0) {
      alert('Please generate a schedule first using "Generate New Schedule" button.');
      return;
    }
    window.print();
  });

  // Prevent iOS double-tap zoom on buttons
  let lastTap = 0;
  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTap < 300) {
      e.preventDefault();
    }
    lastTap = now;
  });
})();
</script>
</body>
</html>
